<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
        }

        #userMessage {
            width: 60%;
            padding: 8px;
            margin-right: 10px;
        }

        #actionButtons {
            margin-top: 10px;
        }

        .chatButton {
            padding: 8px;
            cursor: pointer;
            margin-right: 5px;
        }

        #chatbox {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            text-align: left;
        }

        #loadingIndicator {
            display: none;
            margin-top: 10px;
        }

        @keyframes loadingAnimation {
            0% {
                content: '⠋';
            }
            25% {
                content: '⠙';
            }
            50% {
                content: '⠹';
            }
            75% {
                content: '⠸';
            }
            100% {
                content: '⠼';
            }
        }

        .loading-text::before {
            content: '⠋';
            animation: loadingAnimation 0.5s infinite;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div>
        <label for="userMessage">Enter your message:</label>
        <input type="text" id="userMessage" />
    </div>

    <div id="actionButtons">
        <button class="chatButton" onclick="sendMessage()">Send</button>
        <button class="chatButton" onclick="regenerateAnswer()">Regenerate</button>
        <button class="chatButton" onclick="goBack()">Go Back</button>
    </div>

    <div id="loadingIndicator" class="loading-text"></div>

    <div id="chatbox"></div>

    <script>
        // Maintain conversation history
        let conversationHistory = [];
        let lastUserMessageIndex = -1;

        function showLoadingIndicator() {
            document.getElementById('loadingIndicator').style.display = 'inline-block';
        }

        function hideLoadingIndicator() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function sendMessage() {
            const userMessage = document.getElementById('userMessage').value;

            // Add user message to conversation history
            conversationHistory.push({ role: 'user', content: userMessage });

            // Display loading indicator
            showLoadingIndicator();

            // Create a prompt string from conversation history
            const prompt = conversationHistory.map(message => message.content).join('\n');

            // Make an HTTP request to the chatbot server
            fetch('http://localhost:1234/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt,  // Include the prompt
                    temperature: 0.7,
                    max_tokens: -1,
                    stream: false
                })
            })
            .then(response => response.json())
            .then(data => {
                // Add chatbot response to conversation history
                conversationHistory.push({ role: 'assistant', content: data.choices[0].message.content });

                // Update the UI with the conversation history
                updateChatbox();
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                // Hide loading indicator after the request is complete
                hideLoadingIndicator();
            });
        }

        function regenerateAnswer() {
            // Remove the last assistant response
            conversationHistory.pop();
            // Mark the index of the last user message
            lastUserMessageIndex = conversationHistory.findIndex(message => message.role === 'user');
            // Call sendMessage to regenerate the answer
            sendMessage();
        }

        function goBack() {
            // Remove the last assistant response
            conversationHistory.pop();
            // Remove all messages after the last user message
            conversationHistory = conversationHistory.slice(0, lastUserMessageIndex + 1);
            // Update the UI with the updated conversation history
            updateChatbox();
        }

        function updateChatbox() {
            const chatbox = document.getElementById('chatbox');
            chatbox.innerHTML = '';

            // Display the entire conversation
            for (const message of conversationHistory) {
                const role = message.role === 'user' ? 'User' : 'Chatbot';
                chatbox.innerHTML += `<p>${role}: ${message.content}</p>`;
            }
        }
    </script>
</body>
</html>
